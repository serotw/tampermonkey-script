// ==UserScript==
// @name         DM5-Viewer-Plugin
// @namespace    http://sero.idv.tw/
// @version      0.4
// @description  add some in DM5 View Mode
// @author       sero
// @homepage     http://git.sero.idv.tw
// @include      /^http(s)*:\/\/([^\/]*\.)?(dm5|dm9){1}\.(cn|com|net){1}\/(manhua-([^\/])+|m(\d)+(-p\d+)*){1}(\/)*$/
// @icon         https://www.google.com/s2/favicons?domain=dm5.com
// @grant        none
// @downloadURL  https://github.com/serotw/tampermonkey-script/raw/main/DM5-Viewer-Plugin/DM5-Viewer-Plugin.min.user.js
// ==/UserScript==

!function(win){"use strict";let $=null,pp=console.log;const source="https://cdn.staticfile.org/jquery/3.5.0/jquery.min.js";function type(){return arguments[0]&&typeof arguments[0]}function isString(){return"string"===type(arguments[0])}function isStrings(){return isString(arguments[0])&&""!==arguments[0].trim()}function isArray(){return isObject(arguments[0])&&arguments[0]instanceof Array}function isArrays(){return isArray(arguments[0])&&arguments[0].length}function isObject(){return"object"===type(arguments[0])}function isFunction(){return"function"===type(arguments[0])}function isNull(){return null==arguments[0]}function isJQuery(){return arguments[0]&&"object"===type(arguments[0])&&"jquery"in arguments[0]&&arguments[0].length}function explode(){let e=arguments[0]||null;var t=arguments[1]||null;isStrings(t)&&(isStrings(e)||(e=" "),t.split(e))}function implode(){let e=arguments[0]||null;var t=arguments[1]||null;if(isArrays(t))return isStrings(e)||(e=" "),t.join(e)}function incJQuery(){isFunction(win.jQuery)||$("<script>").attr({src:source}).appendTo("body")}function incPhotos(){isFunction(win.jQuery)&&($("<script>").attr({src:"https://cdn.jsdelivr.net/gh/dimsemenov/PhotoSwipe@5.3.8/dist/umd/photoswipe-lightbox.umd.min.js"}).appendTo("body"),$("<script>").attr({src:"https://cdn.jsdelivr.net/gh/dimsemenov/PhotoSwipe@5.3.8/dist/umd/photoswipe.umd.min.js"}).appendTo("body"))}function incViewer(){isFunction(win.jQuery)&&$("<script>").attr({src:"https://cdn.jsdelivr.net/gh/serotw/js-code/jQuery.plugins/jQuery.obViewer/jQuery.obViewer.js"}).appendTo("body")}const plugin=function(){return new plugin.fn.init};plugin.fn=plugin.prototype={fullName:"DM5-Viewer-Plugin",constructor:plugin,retryTimes:10,retryReset:function(){plugin.fn.retryTimes=10},type:"watch",init:function(){var e=plugin.fn.getSelf(this);return/(manhua-){1}/.test(location.href)?(e.type="detail",e.chkCookie()):e.chkCookie().wait()},time:{cache:{},getSelf:function(){return arguments[0]===plugin.fn.time?arguments[0]:plugin.fn.time},show:function(e){var t=plugin.fn.time.getSelf(this);return e in t.cache?t.cache[e]:t.plus(e)},plus:function(e){var t=plugin.fn.time.getSelf(this);return e in t.cache||(t.cache[e]=0),t.cache[e]++}},events:{top:function(e){e.preventDefault(),$("html, body").stop().animate({scrollTop:0},100)}},getSelf:function(){return arguments[0]===plugin.fn?arguments[0]:plugin.fn},addCSS:function(){var e=plugin.fn.getSelf(this);let o=$("style#DM5_Viewer_Plugins");if(!isJQuery(o)){let n=`#nowViewer{z-index:1001;display:block!important;position:fixed;right:20px;top:20px;padding:.25rem .5rem;background-color:rgba(0,0,0,.325);border-radius:4px;}#nowViewer>strong:not(:empty)+span:before,#nowViewer>strong,#nowViewer>span{display:inline-block;vertical-align:bottom;line-height:1;}#nowViewer>strong{font-weight:bold;font-size:1.5em;color:#f00;}#nowViewer>strong:empty+span{display:none!import;}#nowViewer>strong:not(:empty)+span:before,#nowViewer>strong:not(:empty)+span{font-size:.75em;color:#888;}#nowViewer>strong:not(:empty)+span:before{content:'/';}.white #nowViewer{background-color:rgba(0,0,0,.075);}.new-tip, .view-ad, .view-comment, .footer, #imgloading, .view-paging, .view-header-2 a.back, .view-header-2 .right-bar{display:none!important;}.view-header-2{height:auto;line-height:normal;padding:.25rem 0;}#showimage img:last-child,#showimage{margin-bottom:0!important;}#showimage{margin-top:0!important;}#showimage>img{display:block;vertical-align:middle;margin:0 auto;}#showimage>img+img{margin-top:1em;}#top{cursor:pointer;background-image:url("//css122us.cdnmanhua.net/v202303131713/dm5/images/sd/index-top.png");background-repeat:no-repeat;background-position:center;}.rightToolBar a:hover{background-color:rgba(255,255,255,.125);border-radius:4px;}.white .rightToolBar a:hover{background-color:rgba(0,0,0,.125);}`;$.ajax({url:"https://cdn.jsdelivr.net/gh/dimsemenov/PhotoSwipe@5.3.8/dist/photoswipe.css"}).done(function(e,t,i){isNull(e)||"success"!==t||($("<style>").attr({type:"text/css",id:"DM5_Viewer_Photo"}).html(e).appendTo("body"),(o=$("<style>").attr({type:"text/css",id:"DM5_Viewer_Plugins"}).html(n)).appendTo("body"))})}return e},addBtn:function(){var e,t=plugin.fn.getSelf(this),i=$("body>.rightToolBar");return!isJQuery(i)||isJQuery(e=i.find(">a#top"))||(e=$('<a class="text">').attr({id:"top",title:"Top"}).appendTo(i).on("click",t.events.top),$('<div class="tip">').text("TOP").appendTo(e)),t},loadAllImages:function(){const self=plugin.fn.getSelf(this),name="loadAllImages",callback=arguments[0]||null;return $.when((async()=>{const mainElement=$("#showimage");if(isJQuery(mainElement)){mainElement.empty();let page=1,wait=win.DM5_IMAGE_COUNT;const callEnd=function(){var e=mainElement.find(">*").eq(win.DM5_PAGE-1)[0];$("html, body").animate({scrollTop:e.offsetTop},150),isFunction(callback)&&callback()};await $.each(new Array(win.DM5_IMAGE_COUNT),()=>{const imgElement=$("<img>").attr("data-page",page).addClass("photoswipe-image loading").appendTo(mainElement),options=(imgElement.on("load",function(){$(this).attr({"data-photoswipe-width":this.naturalWidth,"data-photoswipe-height":this.naturalHeight}).removeClass("loading"),0==--wait&&setTimeout(callEnd,100)}),{url:`chapterfun.ashx?cid=${win.DM5_CID}&page=${page}&language=1&gtk=6&_cid=${win.DM5_CID}&_mid=${win.DM5_MID}&_dt=${win.DM5_VIEWSIGN_DT}&_sign=`+win.DM5_VIEWSIGN});$.ajax(options).done(function(respone,textStatus,request){isNull(respone)||"success"!==textStatus||eval(respone).forEach(e=>{imgElement.attr("src",e)})}),page++})}})()).then(()=>self)},addViewer:function(){const e=plugin.fn.getSelf(this);const t=arguments[0]||null;function i(){return t&&t(),e}if($&&$.obViewer){var n=$("#showimage");if(isJQuery(n)){const o=$("<div>").attr("id","nowViewer").appendTo("body");$("<strong>").appendTo(o),$("<span>").appendTo(o).text(win.DM5_IMAGE_COUNT||""),e.obViewer=$.obViewer(n[0],{selector:">img[data-page]",element:o.find(">strong")[0]},function(){this.targets&&this.targets.length&&(o.find(">span").text(win.DM5_IMAGE_COUNT||this.targets.length),$.each(this.targets,(e,t)=>{var i="data-viewer-title";$(t).attr(i)||$(t).attr(i,e+1)}))})}}return i()},chkCookie:function(){var e=plugin.fn.getSelf(this),t="isAdult";return win.jQuery&&win.jQuery.cookie&&!win.jQuery.cookie(t)?(win.jQuery.cookie(t,1,{expires:30,path:"/"}),location.reload()):e},start:function(){const e=plugin.fn.getSelf(this);return win.jQuery&&isFunction(win.jQuery)?e.addCSS().addBtn().loadAllImages(function(){e.addViewer(e.end)}):(e.wait(),e)},end:function(){var e,t=plugin.fn.getSelf(this);return isJQuery($("#showimage"))&&(e={gallery:"#showimage",children:"img.photoswipe-image",pswpModule:PhotoSwipe,bgOpacity:.85,showHideOpacity:!0,wheelToZoom:!0},(e=new PhotoSwipeLightbox(e)).addFilter("domItemData",(e,t,i)=>($(t).is("img")&&$.extend(e,{src:$(t).data("src")||$(t).attr("src"),w:$(t).attr("data-photoswipe-width"),h:$(t).attr("data-photoswipe-height")}),e)),e.init()),$("body").css("overflow","auto"),console.clear(),t},listen:function(){var e=plugin.fn.getSelf(this),t="listen";return win.jQuery&&isFunction(win.jQuery)?($&&isFunction($)||($=win.jQuery),"PhotoSwipe"in win?"obViewer"in $?isJQuery($("body>.rightToolBar"))?e.start():(e.time.plus(t),e.log(t,"toolBar"),plugin.fn.retryTimes--,0<e.retryTimes?(setTimeout(e.wait,100),e):e.error(t,"toolBar")):(incViewer(),e.time.plus(t),e.log(t,"incViewer"),plugin.fn.retryTimes--,0<e.retryTimes?(setTimeout(e.wait,100),e):e.error(t,"incViewer")):(incPhotos(),e.time.plus(t),e.log(t,"incPhotos"),plugin.fn.retryTimes--,0<e.retryTimes?(setTimeout(e.wait,100),e):e.error(t,"incPhotos"))):(incJQuery(),e.time.plus(t),e.log(t,"incJQuery"),plugin.fn.retryTimes--,0<e.retryTimes?(setTimeout(e.wait,100),e):e.error(t,"incJQuery"))},wait:function(){var e=plugin.fn.getSelf(this);return"watch"!==e.type?e:e.listen()},error:function(e,t){e&&"undefined"!==e&&null!==e&&(e=implode(" ",e=[this.fullName,"Error:","Can't finish the",e,t||""]),console.error(e),e=null)},log:function(e,t){e&&"undefined"!==e&&null!==e&&(t=implode(" ",t=[this.fullName,"run",e,t||"",this.time.show(e)]),pp(t),t=null)}},win.ViewPlugins=plugin()}(window);
